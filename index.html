<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚³ã‚¸ãƒãƒ‰!! - è©¦åˆä½œæˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<h1 class="title">ã‚³ã‚¸ãƒãƒ‰!!</h1>

<!-- ãƒŠãƒ“ -->
<div class="top-nav">
  <a href="players.html">åç°¿ç®¡ç†</a>
  <a href="attendance.html">å‚åŠ ãƒã‚§ãƒƒã‚¯</a>
  <a class="active" href="index.html">è©¦åˆä½œæˆ</a>
</div>

<!-- è¨­å®š -->
<div class="panel">
  <h2>è©¦åˆè¨­å®š</h2>

  <label>ã‚³ãƒ¼ãƒˆæ•°</label>
  <select id="courtsSelect">
    <option value="1">1ã‚³ãƒ¼ãƒˆ</option>
    <option value="2">2ã‚³ãƒ¼ãƒˆ</option>
  </select>

  <button class="btn primary" id="setupBtn">
    ç¬¬1è©¦åˆã‚’ä½œæˆ
  </button>
</div>

<!-- è©¦åˆå±¥æ­´ -->
<div id="rounds" class="panel">
  <h2>è©¦åˆå±¥æ­´</h2>
  <p class="muted" id="noRoundMsg">ã¾ã è©¦åˆãŒã‚ã‚Šã¾ã›ã‚“</p>
</div>

<!-- æ¬¡ã®è©¦åˆãƒœã‚¿ãƒ³ -->
<div id="nextRoundContainer"></div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
<div id="playerSummary" class="panel" style="display:none;">
  <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
  <div id="playerTable"></div>
</div>

<script src="common.js"></script>

<script>
/* ============================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«
============================ */
let players = [];
let roundNumber = 1;
let schedule = {};

/* ============================
   åˆæœŸåŒ–
============================ */
document.getElementById("setupBtn").onclick = startFirstRound;

/* ============================
   ç¬¬1è©¦åˆä½œæˆ
============================ */
function startFirstRound() {
  const activeNames = getActivePlayers();

  if (!activeNames || activeNames.length < 4) {
    alert("å‚åŠ è€…ã¯4äººä»¥ä¸Šå¿…è¦ã ã‚ˆğŸ’¦");
    return;
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ­£è¦åŒ–ï¼ˆSetå¿…é ˆï¼‰
  players = normalizePlayers(activeNames);
  console.log("ğŸ”¥ åˆæœŸplayers", players);

  // å…¨å“¡ãšã£ã¨å‚åŠ ã§ãã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  schedule = {};
  players.forEach(p => {
    schedule[p.name] = [{ from: 1, to: 999 }];
  });
  saveSchedule(schedule);

  roundNumber = 1;

  document.getElementById("rounds").innerHTML =
    `<h2>è©¦åˆå±¥æ­´</h2>`;
  document.getElementById("noRoundMsg")?.remove();

  document.getElementById("playerSummary").style.display = "block";
  document.getElementById("nextRoundContainer").innerHTML = "";

  createNextRound();
}

/* ============================
   æ¬¡ã®è©¦åˆ
============================ */
function createNextRound() {
  console.log("ğŸ”¥ playersç›´å‰", players);

  const courtCount = Number(document.getElementById("courtsSelect").value);

  const result = generateRound(
    players,
    roundNumber,
    courtCount,
    getAiWeights(),
    getSchedule()
  );

  if (!result) {
    alert("ã‚‚ã†ã“ã‚Œä»¥ä¸Šçµ„ã‚ãªã„ã‹ã‚‚ğŸ¥º");
    return;
  }

  renderRound(result.rounds, result.refs, result.benches);
  renderPlayerTable();

  roundNumber++;
}

/* ============================
   è©¦åˆè¡¨ç¤ºï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰
============================ */
function renderRound(rounds, refs, benches) {
  const area = document.getElementById("rounds");

  const box = document.createElement("div");
  box.className = "match-round";

  box.innerHTML = `<h3>ç¬¬${roundNumber}è©¦åˆ</h3>`;

  rounds.forEach((r, i) => {
    const card = document.createElement("div");
    card.className = "match-card";

    card.innerHTML = `
      <div class="court-title">ã‚³ãƒ¼ãƒˆ${i + 1}</div>
      <div class="teams">
        <div class="team team-a">
          ${players[r.teamA[0]].name} & ${players[r.teamA[1]].name}
        </div>
        <div class="vs">VS</div>
        <div class="team team-b">
          ${players[r.teamB[0]].name} & ${players[r.teamB[1]].name}
        </div>
      </div>
      <div class="ref">
        å¯©åˆ¤ï¼š${players[refs[i]].name}
      </div>
    `;

    box.appendChild(card);
  });

  if (benches.length > 0) {
    const rest = document.createElement("div");
    rest.className = "rest";
    rest.textContent =
      "ä¼‘æ†©ï¼š" + benches.map(i => players[i].name).join(" / ");
    box.appendChild(rest);
  }

  area.appendChild(box);

  // æ¬¡ã®è©¦åˆãƒœã‚¿ãƒ³ã‚’æœ€æ–°ã®ä¸‹ã«
  document.getElementById("nextRoundContainer").innerHTML = `
    <button class="btn primary" onclick="createNextRound()">
      æ¬¡ã®è©¦åˆã‚’ä½œæˆ
    </button>
  `;
}

/* ============================
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
============================ */
function renderPlayerTable() {
  let html = `
    <table>
      <tr>
        <th>åå‰</th>
        <th>è©¦åˆ</th>
        <th>å¯©åˆ¤</th>
        <th>ä¼‘æ†©</th>
      </tr>
  `;

  players.forEach(p => {
    html += `
      <tr>
        <td>${p.name}</td>
        <td>${p.games}</td>
        <td>${p.refs}</td>
        <td>${p.rests}</td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("playerTable").innerHTML = html;
}
</script>

</body>
</html>

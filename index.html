<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚³ã‚¸ãƒãƒ‰!! - è©¦åˆä½œæˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ff66b3" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <h1 class="title">ã‚³ã‚¸ãƒãƒ‰!!</h1>

  <!-- ãƒŠãƒ“ -->
  <div class="top-nav">
    <a href="players.html">åç°¿ç®¡ç†</a>
    <a href="attendance.html">å‚åŠ ãƒã‚§ãƒƒã‚¯</a>
    <a class="active" href="index.html">è©¦åˆä½œæˆ</a>
  </div>

  <!-- è¨­å®š -->
  <div class="panel">
    <h2>è©¦åˆè¨­å®š</h2>

    <label class="label">ã‚³ãƒ¼ãƒˆæ•°</label>
    <select id="courtsSelect" class="select">
      <option value="1">1ã‚³ãƒ¼ãƒˆ</option>
      <option value="2">2ã‚³ãƒ¼ãƒˆ</option>
      <option value="3">3ã‚³ãƒ¼ãƒˆ</option>
      <option value="4">4ã‚³ãƒ¼ãƒˆ</option>
    </select>

    <button id="setupBtn" class="btn primary">ç¬¬1è©¦åˆã‚’ä½œæˆ</button>
  </div>

  <!-- è©¦åˆå±¥æ­´ -->
  <div id="rounds" class="panel">
    <h2>è©¦åˆå±¥æ­´</h2>
    <p id="noRoundMsg" class="muted">ã¾ã è©¦åˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  </div>

  <!-- æ¬¡ã®è©¦åˆãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«æœ€æ–°è©¦åˆã®ä¸‹ï¼‰ -->
  <div id="nextRoundContainer"></div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <div id="playerSummary" class="panel" style="display:none;">
    <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ³</h2>
    <div id="playerTable"></div>
  </div>

  <!-- å…±é€šãƒ­ã‚¸ãƒƒã‚¯ -->
  <script src="common.js"></script>

  <script>
    let players = [];
    let roundNumber = 1;
    let schedule = {};

    // èµ·å‹•
    window.onload = () => {
      document.getElementById("setupBtn").onclick = setupAndCreateFirstRound;
    };

    function setupAndCreateFirstRound() {
      const activeNames = getActivePlayers();

      if (!activeNames || activeNames.length < 4) {
        alert("å‚åŠ è€…ã¯4äººä»¥ä¸Šå¿…è¦ã ã‚ˆğŸ’¦ï¼ˆå‚åŠ ãƒã‚§ãƒƒã‚¯ã§é¸ã‚“ã§ã­ï¼‰");
        return;
      }

      // players åˆæœŸåŒ–ï¼ˆSetæŒã¡ï¼‰
      players = activeNames.map((name, idx) => ({
        name,
        idx,
        games: 0,
        refs: 0,
        rests: 0,
        partners: new Set(),
        opponents: new Set(),
        lastRoundPlayed: 0,
        lastRefRound: 0,
        lastRestRound: 0
      }));

      // å‚åŠ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå…¨å“¡å‚åŠ ã®å‰æã€‚é€”ä¸­å‚åŠ /æŠœã‘ã¯å¾Œã§æ‹¡å¼µOKï¼‰
      schedule = {};
      players.forEach(p => {
        schedule[p.name] = [{ from: 1, to: 999 }];
      });
      saveSchedule(schedule);

      roundNumber = 1;

      // è¡¨ç¤ºã‚’åˆæœŸåŒ–
      const roundsDiv = document.getElementById("rounds");
      roundsDiv.innerHTML = `<h2>è©¦åˆå±¥æ­´</h2>`;
      document.getElementById("nextRoundContainer").innerHTML = "";
      document.getElementById("playerSummary").style.display = "block";

      // ç¬¬1è©¦åˆ
      createNextRound();
    }

    function createNextRound() {
      // å¿µã®ãŸã‚ Set ã‚’å†ä¿è¨¼ï¼ˆã‚³ãƒ”ãƒšäº‹æ•…ãƒ»æ··å…¥å¯¾ç­–ï¼‰
      players = players.map(p => ({
        ...p,
        partners: p.partners instanceof Set ? p.partners : new Set(p.partners || []),
        opponents: p.opponents instanceof Set ? p.opponents : new Set(p.opponents || [])
      }));

      const courtCount = Number(document.getElementById("courtsSelect").value);

      const result = generateRound(
        players,
        roundNumber,
        courtCount,
        getAiWeights(),
        getSchedule()
      );

      if (!result || !result.rounds || result.rounds.length === 0) {
        alert("ã‚‚ã†çµ„ã‚ãªã„ã‹ã‚‚ğŸ¥ºï¼ˆå‚åŠ è€…æ•°ã¨ã‚³ãƒ¼ãƒˆæ•°ã‚’ç¢ºèªã—ã¦ã­ï¼‰");
        return;
      }

      renderRound(result.rounds, result.refs);
      renderPlayerTable();

      roundNumber++;
    }

    // ===== è©¦åˆã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆã“ã“ãŒå®Œæˆå½¢ï¼‰ =====
    function renderRound(rounds, refs) {
      const roundsDiv = document.getElementById("rounds");
      const noMsg = document.getElementById("noRoundMsg");
      if (noMsg) noMsg.remove();

      const box = document.createElement("div");
      box.className = "match-round";
      box.innerHTML = `<h3 class="round-title">ç¬¬${roundNumber}è©¦åˆ</h3>`;

      rounds.forEach((r, i) => {
        const card = document.createElement("div");
        card.className = "match-card";

        const a1 = players[r.teamA[0]].name;
        const a2 = players[r.teamA[1]].name;
        const b1 = players[r.teamB[0]].name;
        const b2 = players[r.teamB[1]].name;
        const ref = players[refs[i]].name;

        card.innerHTML = `
          <div class="match-head">
            <span class="court-badge">ã‚³ãƒ¼ãƒˆ${i + 1}</span>
            <span class="ref-badge">å¯©åˆ¤ï¼š${ref}</span>
          </div>
          <div class="teams">
            <div class="team team-a">${a1} <span class="amp">&amp;</span> ${a2}</div>
            <div class="vs">VS</div>
            <div class="team team-b">${b1} <span class="amp">&amp;</span> ${b2}</div>
          </div>
        `;

        box.appendChild(card);
      });

      roundsDiv.appendChild(box);

      // æœ€æ–°è©¦åˆã®ä¸‹ã«ãƒœã‚¿ãƒ³
      document.getElementById("nextRoundContainer").innerHTML = `
        <button class="btn primary" onclick="createNextRound()">æ¬¡ã®è©¦åˆã‚’ä½œæˆ</button>
      `;
    }

    // ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆè©¦åˆ/å¯©åˆ¤/ä¼‘æ†©ï¼‰ =====
    function renderPlayerTable() {
      let html = `
        <table class="status-table">
          <thead>
            <tr>
              <th>åå‰</th>
              <th>è©¦åˆ</th>
              <th>å¯©åˆ¤</th>
              <th>ä¼‘æ†©</th>
            </tr>
          </thead>
          <tbody>
      `;

      players.forEach(p => {
        html += `
          <tr>
            <td class="name-cell">${p.name}</td>
            <td>${p.games}</td>
            <td>${p.refs}</td>
            <td>${p.rests}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      document.getElementById("playerTable").innerHTML = html;
    }
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>コジバド!!</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<meta name="theme-color" content="#ff66b3">

<style>
h1 {
  text-align: center;
  font-size: 48px;
  margin: 12px 0;
  font-weight: 900;
  color: #ff66b3;
  text-shadow: 2px 2px #ffd6eb;
}

.match-card {
  background: #fff6fc;
  border: 2px solid #ffb3d9;
  padding: 10px;
  border-radius: 12px;
  margin-bottom: 10px;
}

.match-round {
  background: white;
  border: 2px solid #ffd7ef;
  border-radius: 14px;
  padding: 15px;
  margin-bottom: 18px;
}

button {
  width: 100%;
  padding: 14px;
  font-size: 18px;
  background: #ff99cc;
  border: none;
  border-radius: 12px;
  color: white;
  font-weight: bold;
  margin-top: 10px;
}
button:hover {
  background: #ff66b3;
}
</style>
</head>

<body>

<h1>コジバド!!</h1>

<!-- ナビ -->
<div class="top-nav">
  <a href="players.html">名簿管理</a>
  <a href="attendance.html">参加者チェック</a>
  <a class="active" href="index.html">試合作成</a>
</div>

<!-- 設定パネル -->
<div class="panel">
  <h2>試合設定</h2>

  <label>AIモード（固定：最強公平型）</label>
  <select id="aiMode" disabled>
    <option value="A">A：最強公平型</option>
  </select>

  <label>コート数</label>
  <select id="courtsSelect">
    <option value="1">1コート</option>
    <option value="2">2コート</option>
    <option value="3">3コート</option>
    <option value="4">4コート</option>
  </select>

  <button id="setupBtn">参加者を読み込み → 最初の40試合作成</button>
</div>

<!-- 試合履歴 -->
<div id="rounds" class="panel">
  <h2>試合履歴</h2>
  <p id="noRoundMsg">まだ試合がありません。</p>
</div>

<button id="addBtn" style="display:none;">試合を追加（1試合）</button>

<!-- ステータス -->
<div id="playerSummary" class="panel" style="display:none;">
  <h2>プレイヤーステータス</h2>
  <div id="playerTable"></div>
</div>

<script src="common.js"></script>

<script>
/* ================================
   変数
================================ */
let players = [];        // {name, games, refs, rests, ...}
let roundNumber = 1;
let MAX_ROUNDS = 40;

/* ================================
   初期セット
================================ */
window.onload = () => {
  document.getElementById("setupBtn").onclick = setupAndGenerate;
  document.getElementById("addBtn").onclick   = addOneRound;
};

/* ================================
   最初の40試合作成
================================ */
function setupAndGenerate() {
  const names = getActivePlayers();      // 今日の参加者
  const schedule = getSchedule();         // 途中参加・途中抜け設定

  if (names.length < 4) {
    alert("参加者は最低4人必要です！");
    return;
  }

  // プレイヤー初期化
  players = names.map(name => ({
    name,
    games: 0,
    refs: 0,
    rests: 0,
    lastRoundPlayed: 0,
    lastRefRound: 0,
    lastRestRound: 0,
  }));

  roundNumber = 1;

  document.getElementById("rounds").innerHTML =
    "<h2>試合履歴</h2>";

  document.getElementById("playerSummary").style.display = "block";
  document.getElementById("addBtn").style.display = "block";

  renderPlayerTable();

  const courtCount = Number(document.getElementById("courtsSelect").value);

  // 40試合作成
  for (let i = 0; i < MAX_ROUNDS; i++) {
    if (!createNextRound(courtCount, schedule)) break;
  }
}

/* ================================
   1試合追加
================================ */
function addOneRound() {
  const schedule = getSchedule();
  const courtCount = Number(document.getElementById("courtsSelect").value);
  createNextRound(courtCount, schedule);
}

/* ================================
   ラウンド生成
================================ */
function createNextRound(courtCount, schedule) {

  const weights = getAiWeights();

  const result = generateRound(
    players,
    roundNumber,
    courtCount,
    weights,
    schedule   // ★途中参加・途中抜け判定に必要！
  );

  if (!result) {
    alert("これ以上公平に作れません！");
    return false;
  }

  renderRound(result.rounds, result.refs, result.benches);
  renderPlayerTable();
  roundNumber++;

  return true;
}

/* ================================
   UI描画
================================ */

// 試合カード
function renderRound(rounds, refs, benches) {
  const wrap = document.getElementById("rounds");
  const noMsg = document.getElementById("noRoundMsg");
  if (noMsg) noMsg.remove();

  const box = document.createElement("div");
  box.className = "match-round";

  const h3 = document.createElement("h3");
  h3.textContent = `第 ${roundNumber} 試合`;
  box.appendChild(h3);

  rounds.forEach((r, courtID) => {
    const card = document.createElement("div");
    card.className = "match-card";

    card.innerHTML = `
      <p><b>コート${courtID + 1}</b>｜審判：${players[refs[courtID]].name}</p>
      <p>Team A：${players[r.teamA[0]].name} ＆ ${players[r.teamA[1]].name}</p>
      <p>Team B：${players[r.teamB[0]].name} ＆ ${players[r.teamB[1]].name}</p>
    `;
    box.appendChild(card);
  });

  if (benches.length > 0) {
    const rest = document.createElement("p");
    rest.textContent = "休憩：" + benches.map(i => players[i].name).join(" / ");
    box.appendChild(rest);
  }

  wrap.appendChild(box);
}

// ステータス表
function renderPlayerTable() {
  let html = `
    <table>
      <tr>
        <th>名前</th>
        <th>試合数</th>
        <th>審判</th>
        <th>休憩</th>
      </tr>
  `;

  players.forEach(p => {
    html += `
      <tr>
        <td>${p.name}</td>
        <td>${p.games}</td>
        <td>${p.refs}</td>
        <td>${p.rests}</td>
      </tr>
    `;
  });

  html += "</table>";

  document.getElementById("playerTable").innerHTML = html;
}

/* ================================
   PWA Service Worker
================================ */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>

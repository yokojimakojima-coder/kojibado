<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚³ã‚¸ãƒãƒ‰!!</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<meta name="theme-color" content="#ff66b3">
</head>

<body>

<h1>ã‚³ã‚¸ãƒãƒ‰!!</h1>

<!-- ãƒŠãƒ“ -->
<div class="top-nav">
  <a href="players.html">åç°¿ç®¡ç†</a>
  <a href="attendance.html">å‚åŠ è€…ãƒã‚§ãƒƒã‚¯</a>
  <a class="active" href="index.html">è©¦åˆä½œæˆ</a>
</div>


<!-- è©¦åˆè¨­å®š -->
<div class="block">
  <h2>è©¦åˆè¨­å®š</h2>

  <label>ã‚³ãƒ¼ãƒˆæ•°</label>
  <select id="courtsSelect">
    <option value="1">1ã‚³ãƒ¼ãƒˆ</option>
    <option value="2">2ã‚³ãƒ¼ãƒˆ</option>
    <option value="3">3ã‚³ãƒ¼ãƒˆ</option>
    <option value="4">4ã‚³ãƒ¼ãƒˆ</option>
  </select>

  <button id="setupBtn">å‚åŠ è€…ã‚’èª­ã¿è¾¼ã¿ â†’ è‡ªå‹•ã§40è©¦åˆä½œæˆ</button>
</div>


<!-- ğŸ”¥ é€”ä¸­å‚åŠ  / é€”ä¸­æŠœã‘ UI ã“ã“ã‹ã‚‰ -->
<div class="block">
  <h2>é€”ä¸­å‚åŠ  / é€”ä¸­æŠœã‘</h2>

  <label>ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</label>
  <select id="schedulePlayerSelect"></select>

  <div style="display:flex; gap:10px; margin-top:10px;">
    <button class="pink" onclick="joinNow()">é€”ä¸­å‚åŠ ã•ã›ã‚‹</button>
    <button class="red" onclick="leaveNow()">é€”ä¸­æŠœã‘ã•ã›ã‚‹</button>
  </div>

  <button class="green" style="margin-top:10px;" onclick="rebuildFromHere()">
    ğŸ”„ ä»Šã®è©¦åˆæ•°ã‹ã‚‰å†æ§‹ç¯‰ã™ã‚‹ï¼ˆéå»ã¯ä¿æŒï¼‰
  </button>
</div>
<!-- ã“ã“ã¾ã§ -->


<!-- è©¦åˆå±¥æ­´ -->
<div id="rounds" class="block">
  <h2>è©¦åˆå±¥æ­´</h2>
  <p id="noRoundMsg">ã¾ã è©¦åˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
</div>

<button id="addBtn" style="display:none;">è©¦åˆã‚’è¿½åŠ ï¼ˆ1è©¦åˆï¼‰</button>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
<div id="playerSummary" class="block" style="display:none;">
  <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
  <div id="playerTable"></div>
</div>

<script src="common.js"></script>

<script>
let players = [];
let roundNumber = 1;
let schedule = {}; // â† é€”ä¸­å‚åŠ /æŠœã‘ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

window.onload = () => {
  document.getElementById("setupBtn").onclick = setupAndGenerate40;
  document.getElementById("addBtn").onclick = addOneRound;

  loadScheduleSelect();
};

/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ä½œæˆ */
function loadScheduleSelect() {
  const all = getAllPlayers();
  const sel = document.getElementById("schedulePlayerSelect");
  sel.innerHTML = "";
  all.forEach(name => {
    const op = document.createElement("option");
    op.value = name;
    op.textContent = name;
    sel.appendChild(op);
  });
}

/* 40è©¦åˆä½œæˆ */
function setupAndGenerate40() {
  const names = getActivePlayers();
  schedule = getSchedule();

  if (names.length < 4) {
    alert("å‚åŠ è€…ã¯æœ€ä½4äººå¿…è¦ã§ã™ï¼");
    return;
  }

  players = names.map((n, i) => ({
    name: n,
    idx: i,
    games: 0,
    refs: 0,
    rests: 0,
    partners: new Set(),
    opponents: new Set(),
    lastRoundPlayed: 0,
    lastRefRound: 0,
    lastRestRound: 0
  }));

  roundNumber = 1;

  document.getElementById("rounds").innerHTML = "<h2>è©¦åˆå±¥æ­´</h2>";
  document.getElementById("playerSummary").style.display = "block";
  document.getElementById("addBtn").style.display = "block";

  renderPlayerTable();

  const courtCount = Number(document.getElementById("courtsSelect").value);

  for (let i = 0; i < 40; i++) {
    if (!createNextRound(courtCount)) break;
  }
}

/* é€”ä¸­å‚åŠ  */
function joinNow() {
  const name = document.getElementById("schedulePlayerSelect").value;
  const now = roundNumber;

  if (!schedule[name]) schedule[name] = [];

  schedule[name].push({ from: now, to: 9999 });

  saveSchedule(schedule);

  alert(name + " ã‚’ " + now + " è©¦åˆç›®ã‹ã‚‰å‚åŠ ã«è¨­å®šã—ã¾ã—ãŸï¼");
}

/* é€”ä¸­æŠœã‘ */
function leaveNow() {
  const name = document.getElementById("schedulePlayerSelect").value;
  const now = roundNumber;

  if (!schedule[name]) schedule[name] = [];

  schedule[name].push({ from: 1, to: now - 1 });

  saveSchedule(schedule);

  alert(name + " ã¯ " + (now - 1) + " è©¦åˆç›®ã¾ã§ã§é€€å‡ºæ‰±ã„ã«ãªã‚Šã¾ã—ãŸï¼");
}

/* ã“ã“ã‹ã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆéå»ä¿æŒï¼‰ */
function rebuildFromHere() {
  const courtCount = Number(document.getElementById("courtsSelect").value);

  document.getElementById("rounds").innerHTML =
    `<h2>è©¦åˆå±¥æ­´ï¼ˆ${roundNumber} è©¦åˆç›®ã‹ã‚‰å†é–‹ï¼‰</h2>`;

  for (let i = 0; i < 40; i++) {
    if (!createNextRound(courtCount)) break;
  }

  alert("å†æ§‹ç¯‰å®Œäº†ï¼ã“ã“ã‹ã‚‰æ–°ã—ã„å‚åŠ çŠ¶æ³ã§è©¦åˆãŒç¶šãã¾ã™ï¼");
}

/* 1è©¦åˆè¿½åŠ  */
function addOneRound() {
  const courtCount = Number(document.getElementById("courtsSelect").value);
  createNextRound(courtCount);
}

/* ãƒ©ã‚¦ãƒ³ãƒ‰ç”Ÿæˆ */
function createNextRound(courtCount) {
  const result = generateRound(players, roundNumber, courtCount, getAiWeights(), schedule);

  if (!result) {
    alert("ã“ã‚Œä»¥ä¸Šä½œã‚Œã¾ã›ã‚“ï¼");
    return false;
  }

  renderRound(result.rounds, result.refs, result.benches);
  renderPlayerTable();

  roundNumber++;
  return true;
}

/* ãƒ©ã‚¦ãƒ³ãƒ‰è¡¨ç¤º */
function renderRound(rounds, refs, benches) {
  const roundsDiv = document.getElementById("rounds");

  const box = document.createElement("div");
  box.className = "match-round";

  const h = document.createElement("h3");
  h.textContent = "ç¬¬ " + roundNumber + " è©¦åˆ";
  box.appendChild(h);

  rounds.forEach((r, i) => {
    const card = document.createElement("div");
    card.className = "match-card";
    card.innerHTML = `
      <p><b>ã‚³ãƒ¼ãƒˆ${i+1}</b>ï¼ˆå¯©åˆ¤ï¼š${players[refs[i]].name}ï¼‰</p>
      <p>Team Aï¼š${players[r.teamA[0]].name} ï¼† ${players[r.teamA[1]].name}</p>
      <p>Team Bï¼š${players[r.teamB[0]].name} ï¼† ${players[r.teamB[1]].name}</p>
    `;
    box.appendChild(card);
  });

  if (benches.length > 0) {
    const rest = document.createElement("p");
    rest.textContent = "ä¼‘æ†©ï¼š" + benches.map(i => players[i].name).join(" / ");
    box.appendChild(rest);
  }

  roundsDiv.appendChild(box);
}

/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ« */
function renderPlayerTable() {
  let html = `
    <table>
      <tr>
        <th>åå‰</th>
        <th>è©¦åˆæ•°</th>
        <th>å¯©åˆ¤</th>
        <th>ä¼‘æ†©</th>
      </tr>
  `;

  players.forEach(p => {
    html += `
      <tr>
        <td>${p.name}</td>
        <td>${p.games}</td>
        <td>${p.refs}</td>
        <td>${p.rests}</td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("playerTable").innerHTML = html;
}
</script>

</body>
</html>

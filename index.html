<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>コジバド!!</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script defer src="common.js"></script>

</head>
<body>

<h1 class="kojibado-title">コジバド<span class="bang">!!</span></h1>

<div class="top-nav">
  <a href="players.html">名簿管理</a>
  <a href="attendance.html">参加者チェック</a>
  <a class="active" href="index.html">試合作成</a>
</div>

<div class="block">
  <h2>試合設定</h2>

  <div class="select-row">
    <div style="flex:1;">
      <label>AIモード</label>
      <select id="aiMode">
        <option value="A">A：最強公平型（あなた専用設定）</option>
      </select>
    </div>

    <div style="flex:1;">
      <label>コート数</label>
      <select id="courts">
        <option value="1">1コート</option>
        <option value="2">2コート</option>
        <option value="3">3コート</option>
        <option value="4">4コート</option>
      </select>
    </div>
  </div>

  <button id="setupBtn">参加者を読み込み → 20試合自動生成</button>
  <button id="reloadPlayersBtn" style="margin-top:10px;background:#66ccff;">
    参加者を再読み込み（途中参加・途中退出）
  </button>
</div>

<div id="rounds" class="block">
  <h2>試合履歴</h2>
  <p id="noRoundMsg">まだ試合がありません。</p>
</div>

<button id="addRoundBtn" style="display:none;">試合を追加（1試合）</button>

<div id="playerSummary" class="block" style="display:none;">
  <h2>プレイヤーステータス</h2>
  <div id="playerTable"></div>
</div>

<script>
let players = [];
let roundNumber = 1;
let aiMode = "A";

window.onload = () => {
  document.getElementById("aiMode").onchange =
    () => aiMode = document.getElementById("aiMode").value;

  document.getElementById("setupBtn").onclick = setupAndGenerate20;
  document.getElementById("addRoundBtn").onclick = () => addRound();

  document.getElementById("reloadPlayersBtn").onclick = () => {
    reloadActivePlayers(players, roundNumber);
    alert("参加者を再読み込みしました！");
  };
};

function setupAndGenerate20() {
  const names = JSON.parse(localStorage.getItem("activePlayers") || "[]");
  const startRounds = JSON.parse(localStorage.getItem("activePlayersStartRound") || "{}");

  if (names.length < 4) {
    alert("参加者は4人以上必要です！");
    return;
  }

  players = names.map((n,i)=>({
    name:n, idx:i,
    games:0, refs:0, rests:0,
    partners:new Set(), opponents:new Set(),
    lastRoundPlayed:0, lastRefRound:0, lastRestRound:0,
    startRound:startRounds[n] || 1
  }));

  roundNumber = 1;

  document.getElementById("rounds").innerHTML = "<h2>試合履歴</h2>";
  document.getElementById("addRoundBtn").style.display = "block";
  document.getElementById("playerSummary").style.display = "block";

  renderPlayerTable();

  const courts = Number(document.getElementById("courts").value);

  for (let i=0; i<20; i++) {
    if (!createNextRound(courts)) break;
  }
}

function addRound() {
  const courts = Number(document.getElementById("courts").value);
  createNextRound(courts);
}

function createNextRound(courts) {
  const result = generateRound(players, roundNumber, courts);

  if (!result) {
    alert("これ以上公平に作れません！");
    return false;
  }

  renderRound(result);
  renderPlayerTable();
  roundNumber++;

  return true;
}

function renderRound(result) {
  const roundsDiv = document.getElementById("rounds");
  const noMsg = document.getElementById("noRoundMsg");
  if (noMsg) noMsg.remove();

  const box = document.createElement("div");
  box.className = "match-round";

  box.innerHTML = `<h3>第 ${roundNumber} 試合</h3>`;

  result.matches.forEach((m,i)=>{
    const card = document.createElement("div");
    card.className = "match-card";

    card.innerHTML = `
      <p><b>コート${i+1}</b>（審判：${players[m.ref].name}）</p>
      <p>Team A：${players[m.A1].name} ＆ ${players[m.A2].name}</p>
      <p>Team B：${players[m.B1].name} ＆ ${players[m.B2].name}</p>
    `;

    box.appendChild(card);
  });

  if (result.bench.length > 0) {
    const rest = document.createElement("p");
    rest.textContent = "休憩：" + result.bench.map(i=>players[i].name).join(" / ");
    box.appendChild(rest);
  }

  roundsDiv.appendChild(box);
}

function renderPlayerTable() {
  let html = `
  <table>
    <tr>
      <th>名前</th><th>試合</th><th>審判</th><th>休憩</th>
    </tr>
  `;

  players.forEach(p=>{
    html += `
    <tr>
      <td>${p.name}</td>
      <td>${p.games}</td>
      <td>${p.refs}</td>
      <td>${p.rests}</td>
    </tr>`;
  });

  html += "</table>";

  document.getElementById("playerTable").innerHTML = html;
}
</script>

</body>
</html>

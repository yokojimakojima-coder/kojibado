<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚³ã‚¸ãƒãƒ‰!! - è©¦åˆä½œæˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<h1 class="title">ã‚³ã‚¸ãƒãƒ‰!!</h1>

<div class="top-nav">
  <a href="players.html">åç°¿ç®¡ç†</a>
  <a href="attendance.html">å‚åŠ ãƒã‚§ãƒƒã‚¯</a>
  <a class="active" href="index.html">è©¦åˆä½œæˆ</a>
</div>

<div class="setting-block">
  <h2>è©¦åˆè¨­å®š</h2>

  <label>ã‚³ãƒ¼ãƒˆæ•°</label>
  <select id="courtsSelect">
    <option value="1">1ã‚³ãƒ¼ãƒˆ</option>
    <option value="2">2ã‚³ãƒ¼ãƒˆ</option>
  </select>

  <button id="setupBtn">ç¬¬1è©¦åˆã‚’ä½œæˆ</button>
</div>

<div id="rounds" class="setting-block">
  <h2>è©¦åˆå±¥æ­´</h2>
</div>

<div id="nextRoundContainer"></div>

<div id="statusBlock" class="setting-block">
  <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
  <div id="statusTableWrap"></div>
</div>

<script src="common.js"></script>

<script>
let players = [];
let roundNumber = 1;
let schedule = {};

document.getElementById("setupBtn").onclick = () => {
  const activeNames = getActivePlayers();

  if (!activeNames || activeNames.length < 4) {
    alert("å‚åŠ è€…ã¯4äººä»¥ä¸Šå¿…è¦ã ã‚ˆğŸ’¦");
    return;
  }

  // âœ… common.js ã® normalizePlayers ã‚’ä½¿ã†ï¼ˆã“ã‚ŒãŒæ­£ï¼‰
  players = normalizePlayers(activeNames);

  // å…¨å“¡å‚åŠ ã§ãã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  schedule = {};
  players.forEach(p => {
    schedule[p.name] = [{ from: 1, to: 999 }];
  });
  saveSchedule(schedule);

  roundNumber = 1;
  document.getElementById("rounds").innerHTML = "<h2>è©¦åˆå±¥æ­´</h2>";
  document.getElementById("nextRoundContainer").innerHTML = "";

  renderStatus(null); // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  createNextRound();
};

function createNextRound() {
  // Set å†ä¿è¨¼ï¼ˆå¿µã®ãŸã‚ï¼‰
  players = players.map(p => ({
    ...p,
    partners: p.partners instanceof Set ? p.partners : new Set(),
    opponents: p.opponents instanceof Set ? p.opponents : new Set()
  }));

  const courtCount = Number(document.getElementById("courtsSelect").value);

  const result = generateRound(
    players,
    roundNumber,
    courtCount,
    getAiWeights(),
    getSchedule()
  );

  if (!result || !result.rounds || result.rounds.length === 0) {
    alert("ã‚‚ã†çµ„ã‚ãªã„ã‹ã‚‚ğŸ¥º");
    return;
  }

  renderRound(result.rounds, result.refs, result.benches);
  renderStatus(result.benches);

  roundNumber++;
}

function renderRound(rounds, refs, benches) {
  const box = document.createElement("div");
  box.className = "match-round";

  // ã‚¿ã‚¤ãƒˆãƒ«
  box.innerHTML = `<div class="round-title">ç¬¬${roundNumber}è©¦åˆ</div>`;

  // âœ… ã‚«ãƒ¼ãƒ‰ã§è¡¨ç¤ºï¼ˆA & B vs C & D / å¯©åˆ¤ / ä½•å›ç›®ï¼‰
  rounds.forEach((r, i) => {
    const a0 = r.teamA[0], a1 = r.teamA[1], b0 = r.teamB[0], b1 = r.teamB[1];
    const ref = refs[i];

    const lineMain = `${players[a0].name} & ${players[a1].name}  vs  ${players[b0].name} & ${players[b1].name}`;
    const lineRef  = `å¯©åˆ¤ï¼š${players[ref].name}ï¼ˆ${players[ref].refs}å›ç›®ï¼‰`;

    // ã€Œã“ã®è©¦åˆã€èª°ãŒä½•å›ç›®ã€ï¼ players ã® games ãŒã“ã®è©¦åˆå¾Œã«å¢—ãˆã¦ã‚‹ã®ã§ã€ãã®ã¾ã¾è¡¨ç¤ºOK
    const lineCount =
      `${players[a0].name}:${players[a0].games}å›ç›® / ` +
      `${players[a1].name}:${players[a1].games}å›ç›® / ` +
      `${players[b0].name}:${players[b0].games}å›ç›® / ` +
      `${players[b1].name}:${players[b1].games}å›ç›®`;

    box.innerHTML += `
      <div class="match-card">
        <div class="match-court">ã‚³ãƒ¼ãƒˆ${i + 1}</div>
        <div class="match-main">${lineMain}</div>
        <div class="match-sub">${lineRef}</div>
        <div class="match-sub">${lineCount}</div>
      </div>
    `;
  });

  // ä¼‘æ†©ãƒ¡ãƒ³ãƒãƒ¼ã‚‚è¡¨ç¤º
  if (benches && benches.length > 0) {
    const benchNames = benches.map(i => `${players[i].name}ï¼ˆä¼‘æ†©${players[i].rests}å›ç›®ï¼‰`).join(" / ");
    box.innerHTML += `
      <div class="bench-card">
        <div class="bench-title">ä¼‘æ†©</div>
        <div class="bench-main">${benchNames}</div>
      </div>
    `;
  }

  document.getElementById("rounds").appendChild(box);

  document.getElementById("nextRoundContainer").innerHTML =
    `<button class="next-btn" onclick="createNextRound()">æ¬¡ã®è©¦åˆã‚’ä½œæˆ</button>`;
}

function renderStatus(benches) {
  // benches ã¯ indexé…åˆ—ã€‚ç„¡ã„ã¨ãã¯ç©º
  const benchSet = new Set(benches || []);

  let html = `
    <div class="status-wrap">
      <div class="status-head">
        <div>åå‰</div>
        <div>è©¦åˆ</div>
        <div>å¯©åˆ¤</div>
        <div>ä¼‘æ†©</div>
        <div>ä»Šå›</div>
      </div>
  `;

  players.forEach((p, idx) => {
    const now = benchSet.has(idx) ? "ä¼‘æ†©" : "å‡ºå ´/å¯©åˆ¤";
    html += `
      <div class="status-row">
        <div class="status-name">${p.name}</div>
        <div>${p.games}</div>
        <div>${p.refs}</div>
        <div>${p.rests}</div>
        <div>${now}</div>
      </div>
    `;
  });

  html += `</div>`;
  document.getElementById("statusTableWrap").innerHTML = html;
}
</script>

</body>
</html>

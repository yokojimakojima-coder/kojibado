<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚³ã‚¸ãƒãƒ‰!! - è©¦åˆä½œæˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<meta name="theme-color" content="#ff66b3">

<style>
h1 {
  text-align:center;
  font-size:42px;
  font-weight:900;
  color:#ff66b3;
  text-shadow:2px 2px #ffd6eb;
  margin:10px 0 20px;
}

.setting-block {
  background:#fff;
  border-radius:12px;
  padding:15px;
  margin-bottom:20px;
  border:2px solid #ffd3ec;
}

.match-round {
  background:#fff;
  border:2px solid #ffd3ec;
  border-radius:12px;
  padding:15px;
  margin-bottom:25px;
}

.match-card {
  background:#fff6fc;
  padding:12px;
  border-radius:10px;
  border:1px solid #ffb3d9;
  margin-bottom:10px;
}

button {
  width:100%;
  padding:15px;
  border:none;
  border-radius:10px;
  background:#ff99cc;
  color:white;
  font-size:18px;
  font-weight:bold;
  margin-top:10px;
}

button:hover {
  background:#ff66b3;
}
</style>
</head>

<body>

<h1>ã‚³ã‚¸ãƒãƒ‰!!</h1>

<!-- ãƒŠãƒ“ -->
<div class="top-nav">
  <a href="players.html">åç°¿ç®¡ç†</a>
  <a href="attendance.html">å‚åŠ è€…ãƒã‚§ãƒƒã‚¯</a>
  <a class="active" href="index.html">è©¦åˆä½œæˆ</a>
</div>

<!-- è©¦åˆè¨­å®š -->
<div class="setting-block">
  <h2>è©¦åˆè¨­å®š</h2>

  <label>ã‚³ãƒ¼ãƒˆæ•°</label>
  <select id="courtsSelect">
    <option value="1">1ã‚³ãƒ¼ãƒˆ</option>
    <option value="2">2ã‚³ãƒ¼ãƒˆ</option>
    <option value="3">3ã‚³ãƒ¼ãƒˆ</option>
    <option value="4">4ã‚³ãƒ¼ãƒˆ</option>
  </select>

  <button id="setupBtn">å‚åŠ è€…ã‚’èª­ã¿è¾¼ã¿ â†’ ç¬¬1è©¦åˆã‚’ä½œæˆ</button>
</div>

<!-- é€”ä¸­å‚åŠ ãƒ»é€”ä¸­æŠœã‘ -->
<div class="setting-block">
  <h2>é€”ä¸­å‚åŠ  / é€”ä¸­æŠœã‘</h2>

  <label>é¸æ‰‹ã‚’é¸æŠ</label>
  <select id="changePlayer"></select>

  <label>çŠ¶æ…‹ã‚’é¸æŠ</label>
  <select id="changeType">
    <option value="join">é€”ä¸­å‚åŠ ï¼ˆã“ã®è©¦åˆã‹ã‚‰å‚åŠ ï¼‰</option>
    <option value="leave">é€”ä¸­æŠœã‘ï¼ˆã“ã®è©¦åˆã¾ã§ã§çµ‚äº†ï¼‰</option>
  </select>

  <button id="applyChangeBtn">å¤‰æ›´ã‚’é©ç”¨</button>
</div>

<!-- è©¦åˆå±¥æ­´ -->
<div id="rounds" class="setting-block">
  <h2>è©¦åˆå±¥æ­´</h2>
  <p id="noRoundMsg">ã¾ã è©¦åˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
</div>

<!-- æ¬¡ã®è©¦åˆä½œæˆï¼ˆå¸¸ã«æœ€å¾Œå°¾ã«é…ç½®ï¼‰ -->
<div id="nextRoundContainer"></div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
<div id="playerSummary" class="setting-block" style="display:none;">
  <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
  <div id="playerTable"></div>
</div>

<script src="common.js"></script>

<script>
/* ===============================
   index.html ãƒ¡ã‚¤ãƒ³å‡¦ç†
=============================== */

let players = [];
let roundNumber = 1;
let schedule = {}; // { åå‰: [{from,to}, ...] }

/* -----------------------------------
   ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
----------------------------------- */
window.onload = () => {

  // ğŸš¨ã“ã‚ŒãŒä»Šå›ã®é‡è¦ä¿®æ­£ï¼šå‰å›ã®NextRoundãƒœã‚¿ãƒ³æ®‹ã‚Šã‚’å¿…ãšå‰Šé™¤
  document.getElementById("nextRoundContainer").innerHTML = "";

  schedule = getSchedule();
  document.getElementById("setupBtn").onclick = firstRound;
  document.getElementById("applyChangeBtn").onclick = applyChange;
};

/* -----------------------------------
   ç¬¬1è©¦åˆã‚’ä½œæˆ
----------------------------------- */
function firstRound() {
  const active = getActivePlayers();
  if (active.length < 4) {
    alert("å‚åŠ è€…ã¯4äººä»¥ä¸Šå¿…è¦ã§ã™ï¼");
    return;
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ–
  players = active.map((n, i) => ({
    name: n,
    idx: i,
    games: 0,
    refs: 0,
    rests: 0,
    partners: new Set(),
    opponents: new Set(),
    lastRoundPlayed: 0,
    lastRefRound: 0,
    lastRestRound: 0
  }));

  // å…¨å“¡ 1ã€œ999è©¦åˆå‚åŠ ã«åˆæœŸåŒ–
  schedule = {};
  players.forEach(p => {
    schedule[p.name] = [{ from: 1, to: 999 }];
  });
  saveSchedule(schedule);

  roundNumber = 1;

  document.getElementById("rounds").innerHTML = `<h2>è©¦åˆå±¥æ­´</h2>`;
  document.getElementById("playerSummary").style.display = "block";

  populateChangePlayerList();

  createNextRound();
}

/* -----------------------------------
   æ¬¡ã®è©¦åˆ
----------------------------------- */
function createNextRound() {
  const courtCount = Number(document.getElementById("courtsSelect").value);

  const result = generateRound(players, roundNumber, courtCount, getAiWeights(), schedule);

  if (!result) {
    alert("ã“ã‚Œä»¥ä¸Šå…¬å¹³ã«ä½œã‚Œã¾ã›ã‚“ï¼");
    return;
  }

  renderRound(result.rounds, result.refs, result.benches);
  renderPlayerTable();

  roundNumber++;
}

/* -----------------------------------
   é€”ä¸­å‚åŠ  / é€”ä¸­æŠœã‘
----------------------------------- */
function populateChangePlayerList() {
  const select = document.getElementById("changePlayer");
  select.innerHTML = "";
  players.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.name;
    opt.textContent = p.name;
    select.appendChild(opt);
  });
}

function applyChange() {
  const name = document.getElementById("changePlayer").value;
  const type = document.getElementById("changeType").value;

  if (!schedule[name]) schedule[name] = [{ from: 1, to: 999 }];

  const lastSeg = schedule[name][schedule[name].length - 1];

  if (type === "join") {
    lastSeg.to = roundNumber - 1;
    schedule[name].push({ from: roundNumber, to: 999 });
  } else if (type === "leave") {
    lastSeg.to = roundNumber - 1;
  }

  saveSchedule(schedule);

  alert("å¤‰æ›´ã‚’åæ˜ ã—ã¾ã—ãŸï¼æ¬¡ã®è©¦åˆä½œæˆã§é©ç”¨ã•ã‚Œã¾ã™ã€‚");
}

/* -----------------------------------
   è©¦åˆè¡¨ç¤º
----------------------------------- */
function renderRound(rounds, refs, benches) {
  const area = document.getElementById("rounds");

  const box = document.createElement("div");
  box.className = "match-round";

  box.innerHTML = `<h3>ç¬¬ ${roundNumber} è©¦åˆ</h3>`;

  rounds.forEach((r, i) => {
    const card = document.createElement("div");
    card.className = "match-card";
    card.innerHTML = `
      <p><b>ã‚³ãƒ¼ãƒˆ${i+1}</b>ï¼ˆå¯©åˆ¤ï¼š${players[refs[i]].name}ï¼‰</p>
      <p>Team Aï¼š${players[r.teamA[0]].name} ï¼† ${players[r.teamA[1]].name}</p>
      <p>Team Bï¼š${players[r.teamB[0]].name} ï¼† ${players[r.teamB[1]].name}</p>
    `;
    box.appendChild(card);
  });

  if (benches.length > 0) {
    box.innerHTML += `<p>ä¼‘æ†©ï¼š${benches.map(i => players[i].name).join(" / ")}</p>`;
  }

  area.appendChild(box);

  // æœ€æ–°ã®ä¸‹ã«å¸¸ã«é…ç½®
  const btnArea = document.getElementById("nextRoundContainer");
  btnArea.innerHTML = `<button onclick="createNextRound()">æ¬¡ã®è©¦åˆã‚’ä½œæˆ</button>`;
}

/* -----------------------------------
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
----------------------------------- */
function renderPlayerTable() {
  let html = `
    <table>
      <tr>
        <th>åå‰</th>
        <th>è©¦åˆæ•°</th>
        <th>å¯©åˆ¤</th>
        <th>ä¼‘æ†©</th>
      </tr>
  `;

  players.forEach(p => {
    html += `
      <tr>
        <td>${p.name}</td>
        <td>${p.games}</td>
        <td>${p.refs}</td>
        <td>${p.rests}</td>
      </tr>
    `;
  });

  html += "</table>";

  document.getElementById("playerTable").innerHTML = html;
}
</script>

</body>
</html>

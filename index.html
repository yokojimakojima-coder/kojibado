<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚³ã‚¸ãƒãƒ‰!! - è©¦åˆä½œæˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1 class="title">ã‚³ã‚¸ãƒãƒ‰!!</h1>

<div class="top-nav">
  <a href="players.html">åç°¿ç®¡ç†</a>
  <a href="attendance.html">å‚åŠ ãƒã‚§ãƒƒã‚¯</a>
  <a class="active" href="index.html">è©¦åˆä½œæˆ</a>
</div>

<!-- è©¦åˆè¨­å®š -->
<div class="setting-block">
  <h2>è©¦åˆè¨­å®š</h2>

  <label>ã‚³ãƒ¼ãƒˆæ•°</label>
  <select id="courtsSelect">
    <option value="1">1ã‚³ãƒ¼ãƒˆ</option>
    <option value="2">2ã‚³ãƒ¼ãƒˆ</option>
  </select>

  <button id="setupBtn">ç¬¬1è©¦åˆã‚’ä½œæˆ</button>
</div>

<!-- è©¦åˆå±¥æ­´ -->
<div id="rounds" class="setting-block">
  <h2>è©¦åˆå±¥æ­´</h2>
</div>

<!-- æ¬¡ã®è©¦åˆ -->
<div id="nextRoundContainer"></div>

<!-- common.jsï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ®ºã—ï¼‰ -->
<script src="common.js?v=final20251212"></script>

<script>
/* =====================================================
   ğŸ’£ æœ€çµ‚å…µå™¨ï¼šindex.html å†…ã§å®Œå…¨åˆæœŸåŒ–
===================================================== */

// ğŸ”¥ çµ¶å¯¾ã«å£Šã‚Œãªã„ player ç”Ÿæˆ
function normalizePlayers(names) {
  return names.map((name, idx) => ({
    name,
    idx,
    games: 0,
    refs: 0,
    rests: 0,
    partners: new Set(),
    opponents: new Set(),
    lastRoundPlayed: 0,
    lastRefRound: 0,
    lastRestRound: 0
  }));
}

let players = [];
let roundNumber = 1;

// ç¬¬1è©¦åˆä½œæˆ
document.getElementById("setupBtn").onclick = () => {
  const activeNames = getActivePlayers();

  if (!activeNames || activeNames.length < 4) {
    alert("å‚åŠ è€…ã¯4äººä»¥ä¸Šå¿…è¦ã ã‚ˆğŸ’¦");
    return;
  }

  // ğŸ”¥ ã“ã“ãŒæœ€é‡è¦ãƒã‚¤ãƒ³ãƒˆ
  players = normalizePlayers(activeNames);

  // schedule åˆæœŸåŒ–
  const schedule = {};
  players.forEach(p => {
    schedule[p.name] = [{ from: 1, to: 999 }];
  });
  saveSchedule(schedule);

  roundNumber = 1;
  document.getElementById("rounds").innerHTML = "<h2>è©¦åˆå±¥æ­´</h2>";

  createNextRound();
};

// æ¬¡ã®è©¦åˆä½œæˆ
function createNextRound() {
  console.log("ğŸ”¥ players ä¸­èº«:", players); // â†ã“ã®1è¡Œã ã‘è¿½åŠ 

  const courtCount = Number(document.getElementById("courtsSelect").value);

  const result = generateRound(
    players,
    roundNumber,
    courtCount,
    getAiWeights(),
    getSchedule()
  );

  if (!result) {
    alert("ã‚‚ã†çµ„ã‚ãªã„ã‹ã‚‚ğŸ¥º");
    return;
  }

  renderRound(result.rounds, result.refs);
  roundNumber++;
}

// è¡¨ç¤º
function renderRound(rounds, refs) {
  const box = document.createElement("div");
  box.className = "match-round";
  box.innerHTML = `<h3>ç¬¬${roundNumber}è©¦åˆ</h3>`;

  rounds.forEach((r, i) => {
    box.innerHTML += `
      <p>
        ã‚³ãƒ¼ãƒˆ${i + 1}ï¼š
        ${players[r.teamA[0]].name} ï¼† ${players[r.teamA[1]].name}
        vs
        ${players[r.teamB[0]].name} ï¼† ${players[r.teamB[1]].name}
        ï¼ˆå¯©åˆ¤ï¼š${players[refs[i]].name}ï¼‰
      </p>
    `;
  });

  document.getElementById("rounds").appendChild(box);

  document.getElementById("nextRoundContainer").innerHTML =
    `<button onclick="createNextRound()">æ¬¡ã®è©¦åˆã‚’ä½œæˆ</button>`;
}
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚³ã‚¸ãƒãƒ‰!!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ff66b3">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- â˜…ã‚¿ã‚¤ãƒˆãƒ«â˜… -->
<h1 class="title-main">
  ã‚³ã‚¸ãƒãƒ‰<span class="title-bang">!!</span>
</h1>

<!-- â˜…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="top-nav">
  <a href="players.html">åç°¿ç®¡ç†</a>
  <a href="attendance.html">å‚åŠ è€…ãƒã‚§ãƒƒã‚¯</a>
  <a class="active" href="index.html">è©¦åˆä½œæˆ</a>
</div>

<!-- â˜…è©¦åˆè¨­å®šãƒ–ãƒ­ãƒƒã‚¯ -->
<div class="block">
  <h2>è©¦åˆè¨­å®š</h2>

  <label>ã‚³ãƒ¼ãƒˆæ•°</label>
  <select id="courtsSelect">
    <option value="1">1ã‚³ãƒ¼ãƒˆ</option>
    <option value="2">2ã‚³ãƒ¼ãƒˆ</option>
    <option value="3">3ã‚³ãƒ¼ãƒˆ</option>
    <option value="4">4ã‚³ãƒ¼ãƒˆ</option>
  </select>

  <button id="setupBtn">
    å‚åŠ è€…ã‚’èª­ã¿è¾¼ã¿ â†’ è‡ªå‹•ã§20è©¦åˆä½œæˆ
  </button>

  <!-- â˜…é€”ä¸­å‚åŠ ç”¨ãƒœã‚¿ãƒ³ -->
  <button id="lateJoinBtn" style="margin-top:10px;">
    é€”ä¸­å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã™ã‚‹
  </button>
</div>

<!-- â˜…è©¦åˆã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
<div id="rounds" class="block">
  <h2>è©¦åˆå±¥æ­´</h2>
  <p id="noRoundMsg">ã¾ã è©¦åˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
</div>

<!-- â˜…è¿½åŠ è©¦åˆãƒœã‚¿ãƒ³ï¼ˆç„¡é™è¿½åŠ OKï¼‰ -->
<button id="addBtn" class="add-round-btn" style="display:none;">
  è©¦åˆã‚’è¿½åŠ ï¼ˆ1è©¦åˆï¼‰
</button>

<!-- â˜…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
<div id="playerSummary" class="block" style="display:none;">
  <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
  <div id="playerTable"></div>
</div>

<script src="common.js"></script>

<script>
let players = [];      // ç¾åœ¨ã®å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ï¼‰
let roundNumber = 1;   // ä½•è©¦åˆç›®ã‹ï¼ˆ1ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰

// æœ€å¼·å…¬å¹³AIã®é‡ã¿ï¼ˆãƒ¢ãƒ¼ãƒ‰1æœ¬å›ºå®šï¼‰
function getAiWeights() {
  return getCommonAiWeights(); // common.js ã®é–¢æ•°ã‚’åˆ©ç”¨
}

window.onload = () => {
  document.getElementById("setupBtn").onclick = setupAndGenerate20;
  document.getElementById("addBtn").onclick = addOneRound;
  document.getElementById("lateJoinBtn").onclick = addLatePlayerFromUI;
};

/* ==========================================
   åˆå›ï¼š20è©¦åˆã„ã£ãã«ä½œæˆ
========================================== */
function setupAndGenerate20() {
  const activeNames = JSON.parse(localStorage.getItem("activePlayers") || "[]");

  if (activeNames.length < 4) {
    alert("å‚åŠ è€…ã¯4äººä»¥ä¸Šå¿…è¦ã§ã™ï¼");
    return;
  }

  // æ—¢å­˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆæœŸåŒ–ï¼ˆå…¨å“¡ã€Œç¬¬1è©¦åˆã‹ã‚‰å‚åŠ ã€ï¼‰
  players = activeNames.map((n, i) => ({
    name: n,
    games: 0,
    refs: 0,
    rests: 0,
    partners: new Set(),
    opponents: new Set(),
    lastRoundPlayed: 0,
    lastRefRound: 0,
    lastRestRound: 0,
    joinRound: 1   // â˜… æœ€åˆã‹ã‚‰å±…ãŸäººã¯ç¬¬1è©¦åˆã‹ã‚‰
  }));

  roundNumber = 1;

  // ç”»é¢åˆæœŸåŒ–
  document.getElementById("rounds").innerHTML = "<h2>è©¦åˆå±¥æ­´</h2>";
  document.getElementById("playerSummary").style.display = "block";
  document.getElementById("addBtn").style.display = "block";

  renderPlayerTable();

  const courtCount = Number(document.getElementById("courtsSelect").value);

  // ã¨ã‚Šã‚ãˆãš20è©¦åˆä½œã‚‹ï¼ˆé€”ä¸­ã§è©°ã¾ã£ãŸã‚‰æ­¢ã¾ã‚‹ï¼‰
  for (let i = 0; i < 20; i++) {
    if (!createNextRound(courtCount)) break;
  }
}

/* ==========================================
   1è©¦åˆã ã‘è¿½åŠ ï¼ˆç„¡é™ã«æŠ¼ã—ã¦OKï¼‰
========================================== */
function addOneRound() {
  const courtCount = Number(document.getElementById("courtsSelect").value);
  createNextRound(courtCount);
}

/* ==========================================
   å®Ÿéš›ã®ã€Œæ¬¡ã®è©¦åˆã€ã‚’AIã§ä½œã‚‹
========================================== */
function createNextRound(courtCount) {
  const result = generateRound(players, roundNumber, courtCount, getAiWeights());

  if (!result) {
    alert("ã“ã‚Œä»¥ä¸Šå…¬å¹³ã«è©¦åˆã‚’çµ„ã‚ã¾ã›ã‚“â€¦ï¼");
    return false;
  }

  renderRound(result.rounds, result.refs, result.benches);
  renderPlayerTable();
  roundNumber++;
  return true;
}

/* ==========================================
   â˜… é€”ä¸­å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³ã®å‡¦ç†
========================================== */
function addLatePlayerFromUI() {
  const all = JSON.parse(localStorage.getItem("allPlayers") || "[]");
  const currentNames = players.map(p => p.name);

  // ã¾ã  players ã«å±…ãªã„ãƒ¡ãƒ³ãƒãƒ¼ã ã‘å€™è£œè¡¨ç¤º
  const candidates = all.filter(n => !currentNames.includes(n));

  if (candidates.length === 0) {
    alert("åç°¿ã«ç™»éŒ²æ¸ˆã¿ã§ã€ã¾ã ä»Šæ—¥å‚åŠ ã—ã¦ãªã„äººãŒã„ã¾ã›ã‚“ï¼");
    return;
  }

  const name = prompt(
    "é€”ä¸­å‚åŠ ã•ã›ã‚‹äººã®åå‰ã‚’å…¥åŠ›ã—ã¦ã­ã€‚\n\nã€å€™è£œã€‘\n" + candidates.join(" / ")
  );

  if (!name) return;

  if (!all.includes(name)) {
    alert("ãã®åå‰ã¯åç°¿ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nå…ˆã«ã€Œåç°¿ç®¡ç†ã€ã§è¿½åŠ ã—ã¦ã­ï¼");
    return;
  }
  if (currentNames.includes(name)) {
    alert("ãã®äººã¯ã™ã§ã«ä»Šå›ã®ãƒ¡ãƒ³ãƒãƒ¼ã«å…¥ã£ã¦ã„ã¾ã™ï¼");
    return;
  }

  // â˜… common.js ã®é–¢æ•°ã§é€”ä¸­å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
  addLatePlayer(name, roundNumber, players);

  // localStorage ã® activePlayers ã«ã‚‚åæ˜ ï¼ˆæ¬¡å›ä»¥é™ã®ãŸã‚ï¼‰
  const active = JSON.parse(localStorage.getItem("activePlayers") || "[]");
  if (!active.includes(name)) {
    active.push(name);
    localStorage.setItem("activePlayers", JSON.stringify(active));
  }

  alert(name + " ã•ã‚“ã‚’ã€Œç¬¬" + roundNumber + "è©¦åˆç›®ã‹ã‚‰ã®é€”ä¸­å‚åŠ ã€ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸï¼\næ¬¡ã«è©¦åˆã‚’ä½œæˆã™ã‚‹ã¨ãã‹ã‚‰è‡ªå‹•ã§çµ„ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚");
}

/* ==========================================
   â˜… ã‚«ãƒ¼ãƒ‰UIã§è©¦åˆè¡¨ç¤º
========================================== */
function renderRound(rounds, refs, benches) {
  const roundsDiv = document.getElementById("rounds");
  const noMsg = document.getElementById("noRoundMsg");
  if (noMsg) noMsg.remove();

  const box = document.createElement("div");
  box.className = "match-block";

  const h = document.createElement("h3");
  h.textContent = "ç¬¬ " + roundNumber + " è©¦åˆ";
  box.appendChild(h);

  rounds.forEach((r, i) => {
    const card = document.createElement("div");
    card.className = "match-card";

    card.innerHTML = `
      <div class="card-header">
        <span class="court-icon">ğŸ¸ ã‚³ãƒ¼ãƒˆ${i + 1}</span>
        <span class="ref-icon">ğŸ‘‘ å¯©åˆ¤ï¼š${players[refs[i]].name}</span>
      </div>

      <div class="team team-a">
        <div class="team-title">ğŸ”µ TEAM A</div>
        <div class="team-members">
          ${players[r.teamA[0]].name} ï¼† ${players[r.teamA[1]].name}
        </div>
      </div>

      <div class="team team-b">
        <div class="team-title">ğŸ”´ TEAM B</div>
        <div class="team-members">
          ${players[r.teamB[0]].name} ï¼† ${players[r.teamB[1]].name}
        </div>
      </div>
    `;
    box.appendChild(card);
  });

  if (benches.length > 0) {
    const rest = document.createElement("p");
    rest.className = "rest-info";
    rest.innerHTML =
      "ğŸ’º ä¼‘æ†©ï¼š" + benches.map(i => players[i].name).join(" / ");
    box.appendChild(rest);
  }

  roundsDiv.appendChild(box);
}

/* ==========================================
   â˜… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨
========================================== */
function renderPlayerTable() {
  let html = `
    <table>
      <tr>
        <th>åå‰</th>
        <th>è©¦åˆæ•°</th>
        <th>å¯©åˆ¤</th>
        <th>ä¼‘æ†©</th>
      </tr>
  `;

  players.forEach(p => {
    html += `
      <tr>
        <td>${p.name}</td>
        <td>${p.games}</td>
        <td>${p.refs}</td>
        <td>${p.rests}</td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("playerTable").innerHTML = html;
}

/* ==========================================
   â˜… PWA Service Worker ç™»éŒ²
========================================== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>

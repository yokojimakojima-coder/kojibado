<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚³ã‚¸ãƒãƒ‰!!</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ff66b3">
<link rel="manifest" href="manifest.webmanifest">
<link rel="stylesheet" href="style.css">

<style>
/* â˜… ã‚³ã‚¸ãƒãƒ‰!! ã‚¢ãƒ‹ãƒ¡ã‚¿ã‚¤ãƒˆãƒ« */
.kojibado-title {
  text-align: center;
  font-size: 62px;
  font-weight: 900;
  font-family: "Hiragino Maru Gothic ProN", "Rounded Mplus 1c", sans-serif;
  margin-top: 20px;
  letter-spacing: 4px;
  background: linear-gradient(45deg,#ff66b3,#ffcc33,#66ff99,#66ccff,#cc99ff,#ff66b3);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  color: transparent;
  animation: fadeSlide 1.5s ease-out forwards, rainbow 7s infinite linear, shakeRotate 2s infinite ease-in-out;
}
.kojibado-title .bang {
  display:inline-block;
  animation: bangBounce 0.8s infinite ease-in-out;
}

@keyframes shakeRotate {0%,100%{transform:rotate(0)}50%{transform:rotate(1.4deg)}}
@keyframes fadeSlide {0%{opacity:0;transform:translateY(-30px) scale(0.9)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes rainbow {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes bangBounce {0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}

/* ------ UI ------ */
body { font-family:"Hiragino Maru Gothic ProN","Rounded Mplus 1c",sans-serif; background:#fff9fe; padding:16px; margin:0; }
.top-nav { display:flex; gap:6px; margin-bottom:16px; }
.top-nav a { flex:1; padding:12px; text-align:center; background:#ff99cc; color:#fff; border-radius:10px; font-weight:bold; text-decoration:none; }
.top-nav a.active { background:#ff66b3; }
.block { background:#fff; padding:14px; border-radius:14px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:22px; }
h2 { border-left:6px solid #ff66b3; padding-left:8px; margin-bottom:10px; font-size:22px; }

select,button { width:100%; padding:12px; border-radius:10px; font-size:16px; }
select { border:2px solid #ffb3d9; background:#ffe6f3; }
button { background:#ff99cc; color:white; font-weight:bold; border:none; cursor:pointer; }
button:hover { background:#ff82bf; }

.match-round { padding:14px; border-radius:14px; background:#fff; border:2px solid #ffd3ec; margin-bottom:16px; }
.match-card { background:#fff6fc; padding:10px; border-radius:10px; border:1px solid #ffb3d9; margin-bottom:8px; }

table { width:100%; border-collapse:collapse; }
th { background:#ffe0f4; padding:8px; }
td { padding:8px; border-bottom:1px solid #ffd3ec; }
</style>
</head>

<body>

<h1 class="kojibado-title">
  ã‚³ã‚¸ãƒãƒ‰<span class="bang">!!</span>
</h1>

<div class="top-nav">
  <a href="players.html">åç°¿ç®¡ç†</a>
  <a href="attendance.html">å‚åŠ è€…ãƒã‚§ãƒƒã‚¯</a>
  <a href="index.html" class="active">è©¦åˆä½œæˆ</a>
</div>

<div class="block">
  <h2>è©¦åˆè¨­å®š</h2>

  <label>AIãƒ¢ãƒ¼ãƒ‰</label>
  <select id="aiMode">
    <option value="D">Dï¼šå…¨éƒ¨ãƒãƒ©ãƒ³ã‚¹ï¼ˆãŠã™ã™ã‚ï¼‰</option>
    <option value="A">Aï¼šæœ€å¼·å…¬å¹³å‹</option>
    <option value="B">Bï¼šãƒšã‚¢é‡è¦–å‹</option>
    <option value="C">Cï¼šä½“åŠ›é‡è¦–å‹</option>
    <option value="ML">MLï¼šæ©Ÿæ¢°å­¦ç¿’ã½ã„ãŠã¾ã‹ã›</option>
  </select>

  <label style="margin-top:10px;">é€”ä¸­å‚åŠ  / é›¢è„±ãƒ©ã‚¦ãƒ³ãƒ‰</label>
  <select id="joinRound">
    <option value="1">1è©¦åˆç›®ã‹ã‚‰</option>
    <option value="5">5è©¦åˆç›®ã‹ã‚‰å‚åŠ </option>
    <option value="10">10è©¦åˆç›®ã‹ã‚‰å‚åŠ </option>
    <option value="15">15è©¦åˆç›®ã‹ã‚‰å‚åŠ </option>
  </select>

  <label style="margin-top:10px;">ã‚³ãƒ¼ãƒˆæ•°</label>
  <select id="courts">
    <option value="1">1ã‚³ãƒ¼ãƒˆ</option>
    <option value="2">2ã‚³ãƒ¼ãƒˆ</option>
    <option value="3">3ã‚³ãƒ¼ãƒˆ</option>
    <option value="4">4ã‚³ãƒ¼ãƒˆ</option>
  </select>

  <button id="startBtn" style="margin-top:14px;">å‚åŠ è€…ã‚’èª­ã¿è¾¼ã¿ â†’ è‡ªå‹•ã§20è©¦åˆä½œæˆ</button>
</div>

<div id="rounds" class="block">
  <h2>è©¦åˆå±¥æ­´</h2>
  <p id="noRound">ã¾ã è©¦åˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
</div>

<button id="addBtn" style="display:none;">è©¦åˆã‚’1ã¤è¿½åŠ ã™ã‚‹</button>

<div id="playerStatus" class="block" style="display:none;">
  <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
  <div id="playerTable"></div>
</div>

<script src="common.js"></script>

<script>
let players = [];
let roundNumber = 1;
let aiMode = "D";
let joinRound = 1;

/* èª­ã¿è¾¼ã¿ */
window.onload = () => {
  aiMode = document.getElementById("aiMode").value;
  joinRound = Number(document.getElementById("joinRound").value);

  document.getElementById("aiMode").onchange = () =>
    aiMode = document.getElementById("aiMode").value;

  document.getElementById("joinRound").onchange = () =>
    joinRound = Number(document.getElementById("joinRound").value);

  document.getElementById("startBtn").onclick = startAndGenerate20;
  document.getElementById("addBtn").onclick = addRound;
};

/* åˆæœŸã‚»ãƒƒãƒˆã—ã¦20è©¦åˆä½œæˆ */
function startAndGenerate20() {
  const active = JSON.parse(localStorage.getItem("activePlayers") || "[]");
  if (active.length < 4) { alert("å‚åŠ è€…ã¯4äººä»¥ä¸Šå¿…è¦ã ã‚ˆğŸ’¦"); return; }

  players = active.map((n,i)=>({
    name:n, idx:i, games:0, refs:0, rests:0,
    partners:new Set(), opponents:new Set(),
    lastPlayed:0, lastRef:0, lastRest:0
  }));

  roundNumber = 1;
  document.getElementById("rounds").innerHTML = "<h2>è©¦åˆå±¥æ­´</h2>";
  document.getElementById("playerStatus").style.display = "block";
  document.getElementById("addBtn").style.display = "block";

  const courts = Number(document.getElementById("courts").value);

  for (let i=0;i<20;i++){
    if(!generateOne(courts)) break;
    roundNumber++;
  }
}

/* é€”ä¸­å‚åŠ ãƒ­ã‚¸ãƒƒã‚¯ã¤ããƒ©ã‚¦ãƒ³ãƒ‰ç”Ÿæˆ */
function generateOne(courts){
  const weights = getCommonAiWeights(aiMode, players);

  // é€”ä¸­å‚åŠ å¯¾å¿œï¼šjoinRound ä»¥å‰ã¯ stats ã‚’0æ‰±ã„
  const p2 = players.map(p=>({...p}));

  if(roundNumber < joinRound){
    p2.forEach(p=>{
      p.games = 0;
      p.refs = 0;
      p.rests = 0;
      p.partners = new Set();
      p.opponents = new Set();
    });
  }

  const result = generateRound(p2, roundNumber, courts, weights);
  if(!result){ alert("ã“ã‚Œä»¥ä¸Šå…¬å¹³ã«çµ„ã‚ãªã‹ã£ãŸã‚ˆğŸ™"); return false; }

  renderRound(result.rounds, result.refs, result.benches);
  updateStats(result);
  renderPlayerTable();

  return true;
}

function addRound(){
  const courts = Number(document.getElementById("courts").value);
  if(generateOne(courts)) roundNumber++;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° */
function updateStats(result){
  result.rounds.forEach((r,i)=>{
    const a1 = r.teamA[0], a2 = r.teamA[1];
    const b1 = r.teamB[0], b2 = r.teamB[1];
    const ref = result.refs[i];

    [a1,a2,b1,b2].forEach(id=>{
      players[id].games++;
      players[id].lastPlayed = roundNumber;
    });

    players[ref].refs++;
    players[ref].lastRef = roundNumber;

    const bench = result.benches;
    bench.forEach(b=>{
      players[b].rests++;
      players[b].lastRest = roundNumber;
    });
  });
}

/* è¡¨ç¤º */
function renderRound(rounds,refs,benches){
  const box = document.createElement("div");
  box.className = "match-round";

  box.innerHTML = `<h3>ç¬¬ ${roundNumber} è©¦åˆ</h3>`;

  rounds.forEach((r,i)=>{
    box.innerHTML += `
      <div class="match-card">
        <p><b>ã‚³ãƒ¼ãƒˆ${i+1}</b>ï¼ˆå¯©åˆ¤ï¼š${players[refs[i]].name}ï¼‰</p>
        <p>Team Aï¼š${players[r.teamA[0]].name} ï¼† ${players[r.teamA[1]].name}</p>
        <p>Team Bï¼š${players[r.teamB[0]].name} ï¼† ${players[r.teamB[1]].name}</p>
      </div>`;
  });

  if(benches.length>0){
    box.innerHTML += `<p>ä¼‘æ†©ï¼š${benches.map(i=>players[i].name).join(" / ")}</p>`;
  }

  const root = document.getElementById("rounds");
  root.appendChild(box);

  const no = document.getElementById("noRound");
  if(no) no.remove();
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
function renderPlayerTable(){
  let html = `
  <table>
    <tr><th>åå‰</th><th>è©¦åˆæ•°</th><th>å¯©åˆ¤</th><th>ä¼‘æ†©</th></tr>
  `;

  players.forEach(p=>{
    html += `<tr>
      <td>${p.name}</td>
      <td>${p.games}</td>
      <td>${p.refs}</td>
      <td>${p.rests}</td>
    </tr>`;
  });

  html += "</table>";
  document.getElementById("playerTable").innerHTML = html;
}

/* PWA */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>

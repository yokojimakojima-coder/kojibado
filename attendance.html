<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>参加者チェック - コジバド!!</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script defer src="common.js"></script>
</head>

<body>

<h2>参加者チェック</h2>

<button class="green" onclick="location.href='players.html'">名前管理へ戻る</button>

<p style="text-align:center; margin-top:10px;">
  今日来ている人にチェックを入れて、参加開始ラウンドを設定してください
</p>

<ul id="activeList"></ul>

<button class="green" onclick="checkAll()">全員 ON</button>
<button class="red" onclick="uncheckAll()">全員 OFF</button>

<button class="green" onclick="saveActivePlayers()">参加者を保存 → 試合作成へ</button>

<script>
// ★ 名簿を参加者チェック画面に読み込む関数（必須）
function loadPlayersToAttendance() {
  const list = JSON.parse(localStorage.getItem("allPlayers") || "[]");
  const active = JSON.parse(localStorage.getItem("activePlayers") || "[]");
  const startRounds = JSON.parse(localStorage.getItem("activePlayersStartRound") || "{}");

  let html = "";

  list.forEach(name => {
    const checked = active.includes(name) ? "checked" : "";
    const start = startRounds[name] || 1;

    html += `
      <div class="checkbox-line">
        <label>
          <input type="checkbox" class="chk" data-name="${name}" ${checked}>
          ${name}
        </label>
        <div>
          参加開始ラウンド：
          <select class="start-select" data-start="${name}">
            ${[...Array(20)].map((_,i)=>`
              <option value="${i+1}" ${start==(i+1)?"selected":""}>${i+1} 試合目</option>
            `).join("")}
          </select>
        </div>
      </div>
    `;
  });

  document.getElementById("playerList").innerHTML = html;
}

// 全員 ON/OFF
function checkAll(){ document.querySelectorAll(".chk").forEach(cb=>cb.checked=true); }
function uncheckAll(){ document.querySelectorAll(".chk").forEach(cb=>cb.checked=false); }

// 保存
function saveActivePlayers() {
  const active = [];
  const startRounds = {};

  document.querySelectorAll(".checkbox-line").forEach(box=>{
    const cb = box.querySelector(".chk");
    const name = cb.dataset.name;
    const startSel = box.querySelector(".start-select").value;

    if (cb.checked) active.push(name);
    startRounds[name] = Number(startSel);
  });

  if (active.length < 4) {
    alert("4人以上選択してください");
    return;
  }

  localStorage.setItem("activePlayers", JSON.stringify(active));
  localStorage.setItem("activePlayersStartRound", JSON.stringify(startRounds));

  alert("保存しました！試合作成へ移動します。");
  location.href = "index.html";
}

// ★ ページ読み込み時に名簿を表示
window.onload = loadPlayersToAttendance;
</script>

</body>
</html>

